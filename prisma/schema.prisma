generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserStatus {
  PENDING
  ACTIVE
  BLOCKED
}

enum ApplicationStatus {
  PENDING_PAYMENT
  NEW
  ASSIGNED
  RESPONSE_GIVEN
  APPROVED
  SENT_TO_CLIENT
  DECLINED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentProvider {
  MOCK
  YOOKASSA
}

enum SkinType {
  DRY
  OILY
  COMBINATION
  NORMAL
}

enum PriceRange {
  UP_TO_5000
  UP_TO_10000
  UP_TO_20000
  OVER_20000
}

enum ApplicationSource {
  TELEGRAM
  WEB
}

enum UserRole {
  CLIENT
  DOCTOR
  ADMIN
}

enum SubscriptionType {
  CLIENT_MONTHLY
  CLIENT_YEARLY
  DOCTOR_MONTHLY
  DOCTOR_YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

// ==================== MODELS ====================

model Client {
  id               Int           @id @default(autoincrement())
  telegramId       BigInt?       @unique @map("telegram_id")
  telegramUsername String?       @map("telegram_username")
  fullName         String?       @map("full_name")
  email            String?       @unique
  passwordHash     String?       @map("password_hash")
  emailVerified    Boolean       @default(false) @map("email_verified")
  phone            String?
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  applications     Application[]
  reviews          Review[]
  procedures       Procedure[]
  careSchemes      CareScheme[]
  subscriptions    Subscription[]

  @@index([telegramId])
  @@index([email])
  @@map("clients")
}

model Doctor {
  id               Int              @id @default(autoincrement())
  telegramId       BigInt?          @unique @map("telegram_id")
  telegramUsername String?          @map("telegram_username")
  fullName         String           @map("full_name")
  email            String?          @unique
  passwordHash     String?          @map("password_hash")
  emailVerified    Boolean          @default(false) @map("email_verified")
  specialization   String?
  bio              String?          @db.Text
  status           UserStatus       @default(PENDING)
  isAvailable      Boolean          @default(true) @map("is_available")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  applications     Application[]
  recommendations  Recommendation[]
  careTemplates    CareTemplate[]
  carePrograms     CareProgram[]
  products         DoctorProduct[]
  notifications    Notification[]
  algorithms       CareAlgorithm[]
  careSchemes      CareScheme[]
  subscriptions    Subscription[]

  @@index([telegramId])
  @@index([status])
  @@index([isAvailable])
  @@map("doctors")
}

model Admin {
  id               Int        @id @default(autoincrement())
  telegramId       BigInt     @unique @map("telegram_id")
  telegramUsername String?    @map("telegram_username")
  fullName         String     @map("full_name")
  status           UserStatus @default(ACTIVE)
  canSeeRevenue    Boolean    @default(false) @map("can_see_revenue")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  @@index([telegramId])
  @@map("admins")
}

model Application {
  id                Int               @id @default(autoincrement())
  clientId          Int               @map("client_id")
  doctorId          Int?              @map("doctor_id")

  // Questionnaire data
  age               Int
  skinType          SkinType          @map("skin_type")
  consultationGoal    String?         @map("consultation_goal")
  additionalProducts  String?         @map("additional_products")
  priceRange        PriceRange?       @map("price_range")
  mainProblems      String            @map("main_problems") @db.Text
  additionalComment String?           @map("additional_comment") @db.Text

  // Display number (fake number shown to client, starts from 100)
  displayNumber     Int?              @unique @map("display_number")

  // Status
  status            ApplicationStatus @default(NEW)
  declineReason     String?           @map("decline_reason") @db.Text

  // Consent
  consentToDataProcessing Boolean @default(false) @map("consent_to_data_processing")

  // Source tracking
  source            ApplicationSource @default(TELEGRAM)

  // Timestamps
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  assignedAt        DateTime?         @map("assigned_at")
  completedAt       DateTime?         @map("completed_at")
  sentToClientAt    DateTime?         @map("sent_to_client_at")
  lastReminderAt    DateTime?         @map("last_reminder_at")

  // Relations
  client            Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  doctor            Doctor?           @relation(fields: [doctorId], references: [id], onDelete: SetNull)
  photos            Photo[]
  recommendation    Recommendation?
  statusHistory     StatusHistory[]
  review            Review?
  payment           Payment?
  notifications     Notification[]
  messages          Message[]
  careSchemes       CareScheme[]

  @@index([clientId])
  @@index([doctorId])
  @@index([status])
  @@index([createdAt])
  @@map("applications")
}

model Photo {
  id             Int         @id @default(autoincrement())
  applicationId  Int         @map("application_id")
  fileName       String      @map("file_name")
  mimeType       String      @map("mime_type")
  fileSize       Int         @map("file_size")
  data           Bytes?
  s3Key          String?     @map("s3_key")
  sortOrder      Int         @default(0) @map("sort_order")
  telegramFileId String?     @map("telegram_file_id")

  // Timeline and categorization
  procedureId    Int?        @map("procedure_id")
  zone           String?     // forehead, cheeks, chin, nose, etc.
  tags           String[]    // acne, redness, texture, dryness, etc.
  description    String?     @db.Text

  createdAt      DateTime    @default(now()) @map("created_at")

  application    Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  procedure      Procedure?  @relation(fields: [procedureId], references: [id], onDelete: SetNull)

  @@index([applicationId])
  @@index([procedureId])
  @@index([zone])
  @@index([createdAt])
  @@map("photos")
}

model Recommendation {
  id              Int         @id @default(autoincrement())
  applicationId   Int         @unique @map("application_id")
  doctorId        Int         @map("doctor_id")

  // Content
  text            String      @db.Text
  links           Json?       // Array of {title: string, url: string}

  // Admin editing
  originalText    String?     @map("original_text") @db.Text
  editedByAdminId Int?        @map("edited_by_admin_id")
  editedByAdminAt DateTime?   @map("edited_by_admin_at")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  application     Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  doctor          Doctor      @relation(fields: [doctorId], references: [id])

  @@index([applicationId])
  @@index([doctorId])
  @@map("recommendations")
}

model StatusHistory {
  id            Int                @id @default(autoincrement())
  applicationId Int                @map("application_id")
  fromStatus    ApplicationStatus? @map("from_status")
  toStatus      ApplicationStatus  @map("to_status")
  comment       String?            @db.Text
  changedById   Int?               @map("changed_by_id")
  changedByRole UserRole?          @map("changed_by_role")
  createdAt     DateTime           @default(now()) @map("created_at")

  application   Application        @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([createdAt])
  @@map("status_history")
}

model AuthCode {
  id         Int      @id @default(autoincrement())
  telegramId BigInt   @map("telegram_id")
  code       String
  expiresAt  DateTime @map("expires_at")
  used       Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([telegramId])
  @@index([code])
  @@index([expiresAt])
  @@map("auth_codes")
}

model Payment {
  id             Int             @id @default(autoincrement())
  applicationId  Int             @unique @map("application_id")
  amount         Float
  status         PaymentStatus   @default(PENDING)
  provider       PaymentProvider @default(MOCK)
  externalId     String?         @map("external_id")
  promoCodeId    Int?            @map("promo_code_id")
  discountAmount Float?          @map("discount_amount")
  createdAt      DateTime        @default(now()) @map("created_at")
  completedAt    DateTime?       @map("completed_at")

  application    Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  promoCode      PromoCode?      @relation(fields: [promoCodeId], references: [id])

  @@index([applicationId])
  @@index([externalId])
  @@map("payments")
}

model Review {
  id            Int      @id @default(autoincrement())
  applicationId Int?     @unique @map("application_id")
  clientId      Int?     @map("client_id")
  rating        Int      // 1-5 stars
  text          String?  @db.Text
  clientName    String?  @map("client_name")
  imageS3Key    String?  @map("image_s3_key")
  isApproved    Boolean  @default(false) @map("is_approved")
  createdAt     DateTime @default(now()) @map("created_at")

  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  client        Client?      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([isApproved])
  @@map("reviews")
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model PromoCode {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  discount  Int       // percentage 0-100
  isActive  Boolean   @default(true) @map("is_active")
  maxUses   Int?      @map("max_uses")
  usedCount Int       @default(0) @map("used_count")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  payments        Payment[]
  giftCertificate GiftCertificate?

  @@map("promo_codes")
}

model GiftCertificate {
  id              Int             @id @default(autoincrement())
  buyerTelegramId BigInt?         @map("buyer_telegram_id")
  buyerEmail      String?         @map("buyer_email")
  amount          Float
  status          PaymentStatus   @default(PENDING)
  provider        PaymentProvider @default(YOOKASSA)
  externalId      String?         @map("external_id")
  promoCodeId     Int?            @unique @map("promo_code_id")
  createdAt       DateTime        @default(now()) @map("created_at")
  completedAt     DateTime?       @map("completed_at")

  promoCode       PromoCode?      @relation(fields: [promoCodeId], references: [id])

  @@index([buyerTelegramId])
  @@index([externalId])
  @@map("gift_certificates")
}

model AnalyticsEvent {
  id        Int      @id @default(autoincrement())
  visitorId String   @map("visitor_id")
  event     String
  referrer  String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([visitorId])
  @@index([event])
  @@index([createdAt])
  @@map("analytics_events")
}

model CareTemplate {
  id        Int      @id @default(autoincrement())
  doctorId  Int      @map("doctor_id")
  title     String
  text      String   @db.Text
  category  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  doctor     Doctor          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  algorithms CareAlgorithm[]

  @@index([doctorId])
  @@map("care_templates")
}

model CareProgram {
  id          Int      @id @default(autoincrement())
  doctorId    Int      @map("doctor_id")
  title       String
  description String?  @db.Text
  steps       Json
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  doctor      Doctor          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  algorithms  CareAlgorithm[]

  @@index([doctorId])
  @@map("care_programs")
}

model DoctorProduct {
  id        Int      @id @default(autoincrement())
  doctorId  Int      @map("doctor_id")
  name      String
  brand     String?
  category  String?
  url       String?
  notes     String?  @db.Text

  // Affiliate/Partner links
  shopUrl       String?  @map("shop_url")         // Direct link to product in store
  affiliateLink String?  @map("affiliate_link")   // Affiliate/referral link
  shopName      String?  @map("shop_name")        // Store name (e.g., "Ozon", "Wildberries")
  commission    Float?                             // Commission percentage (0-100)
  isAffiliate   Boolean  @default(false) @map("is_affiliate")

  // Analytics
  clicks        Int      @default(0)              // Number of clicks on link
  conversions   Int      @default(0)              // Number of purchases/conversions

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([category])
  @@index([isAffiliate])
  @@map("doctor_products")
}

// ==================== NOTIFICATIONS ====================

enum NotificationType {
  NEW_APPLICATION
  STATUS_CHANGE
  NEW_PHOTOS
  RECOMMENDATION_APPROVED
  RECOMMENDATION_DECLINED
  CHAT_MESSAGE
}

model Notification {
  id            Int              @id @default(autoincrement())
  doctorId      Int              @map("doctor_id")
  applicationId Int?             @map("application_id")
  type          NotificationType
  title         String
  message       String           @db.Text
  isRead        Boolean          @default(false) @map("is_read")
  createdAt     DateTime         @default(now()) @map("created_at")

  doctor        Doctor           @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  application   Application?     @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([doctorId, isRead])
  @@index([doctorId, createdAt])
  @@map("notifications")
}

// ==================== CHAT ====================

enum MessageSender {
  DOCTOR
  CLIENT
}

// ==================== PROCEDURES ====================

enum ProcedureType {
  HOME_CARE
  SALON
  MEDICAL
}

enum ProcedureStatus {
  SCHEDULED
  COMPLETED
  SKIPPED
  CANCELLED
}

model Message {
  id            Int           @id @default(autoincrement())
  applicationId Int           @map("application_id")
  senderId      Int?          @map("sender_id")
  senderType    MessageSender @map("sender_type")
  text          String        @db.Text
  isRead        Boolean       @default(false) @map("is_read")
  createdAt     DateTime      @default(now()) @map("created_at")

  application   Application   @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId, createdAt])
  @@index([applicationId, isRead])
  @@map("messages")
}

model Procedure {
  id          Int             @id @default(autoincrement())
  clientId    Int             @map("client_id")
  client      Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)

  type        ProcedureType
  name        String
  description String?         @db.Text

  scheduledAt DateTime        @map("scheduled_at")
  completedAt DateTime?       @map("completed_at")
  status      ProcedureStatus @default(SCHEDULED)

  notes       String?         @db.Text
  photoIds    String[]        @map("photo_ids") // Array of photo IDs

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  photos      Photo[]

  @@index([clientId])
  @@index([scheduledAt])
  @@index([status])
  @@map("procedures")
}

// ==================== CARE ALGORITHMS ====================

model CareAlgorithm {
  id          Int      @id @default(autoincrement())
  doctorId    Int      @map("doctor_id")
  name        String
  description String?  @db.Text
  rules       Json     // array of conditions
  matchMode   String   @default("ALL") // "ALL" = all conditions, "ANY" = any
  outputType  String   // "template" | "program" | "text"
  templateId  Int?     @map("template_id")
  programId   Int?     @map("program_id")
  customText  String?  @map("custom_text") @db.Text
  priority    Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  doctor      Doctor        @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  template    CareTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  program     CareProgram?  @relation(fields: [programId], references: [id], onDelete: SetNull)

  @@index([doctorId, isActive])
  @@map("care_algorithms")
}

// ==================== CARE SCHEMES ====================

model CareScheme {
  id              Int      @id @default(autoincrement())
  clientId        Int      @map("client_id")
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  doctorId        Int?     @map("doctor_id")
  doctor          Doctor?  @relation(fields: [doctorId], references: [id], onDelete: SetNull)

  applicationId   Int?     @map("application_id")
  application     Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  version         Int      @default(1)
  isActive        Boolean  @default(true) @map("is_active")

  // Structured care data
  morningRoutine  Json     @map("morning_routine")   // {steps: [{step, product, instructions}]}
  eveningRoutine  Json     @map("evening_routine")
  weeklyProcedures Json?   @map("weekly_procedures")
  professionalCare Json?   @map("professional_care")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([clientId])
  @@index([doctorId])
  @@index([applicationId])
  @@index([isActive])
  @@map("care_schemes")
}

// ==================== SUBSCRIPTIONS ====================

model SubscriptionPlan {
  id                Int                @id @default(autoincrement())
  name              String
  description       String?            @db.Text
  type              SubscriptionType
  price             Int                // в копейках
  currency          String             @default("RUB")

  // Features
  consultationsPerMonth Int?           @map("consultations_per_month") // null = unlimited
  features          Json               // array of feature strings

  isActive          Boolean            @default(true) @map("is_active")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  subscriptions     Subscription[]

  @@index([type, isActive])
  @@map("subscription_plans")
}

model Subscription {
  id                Int                @id @default(autoincrement())

  // Relations - either client or doctor
  clientId          Int?               @map("client_id")
  client            Client?            @relation(fields: [clientId], references: [id], onDelete: Cascade)

  doctorId          Int?               @map("doctor_id")
  doctor            Doctor?            @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  planId            Int                @map("plan_id")
  plan              SubscriptionPlan   @relation(fields: [planId], references: [id])

  status            SubscriptionStatus @default(PENDING)

  // Dates
  startDate         DateTime           @map("start_date")
  endDate           DateTime           @map("end_date")
  cancelledAt       DateTime?          @map("cancelled_at")

  // Payment
  amount            Int                // в копейках
  currency          String             @default("RUB")
  paymentId         String?            @map("payment_id") // external payment ID

  // Auto-renewal
  autoRenew         Boolean            @default(true) @map("auto_renew")

  // Usage tracking
  consultationsUsed Int                @default(0) @map("consultations_used")

  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  @@index([clientId, status])
  @@index([doctorId, status])
  @@index([status, endDate])
  @@map("subscriptions")
}
